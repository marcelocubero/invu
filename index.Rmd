---
title: "Visor Cuadrantes Urbanos"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: cerulean
    social: menu
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
defaultEncoding <- "UTF8"
library(dplyr)
library(sf)
library(terra)
library(raster)
library(DT)
library(ggplot2)
library(plotly)
library(leaflet)
library(leaflet.extras)
library(leafem)
library(shiny)
library(shinydashboard)
library(shinyWidgets)
library(rgdal)
library(tidyverse)
library(rmapshaper)
library(leaflegend)
```

```{r}

cantones <- st_read("/vsicurl/https://marcelocubero.github.io/capas_TFG/cantones4.geojson",
         quiet = TRUE)

cuadrantes <- st_read("/vsicurl/https://marcelocubero.github.io/capas_TFG/cuadrantes_visor.geojson",
         quiet = TRUE)

mep <- st_read("/vsicurl/https://marcelocubero.github.io/capas_TFG/cr_mep.geojson",
         quiet = TRUE)

localidades <- st_read("/vsicurl/https://marcelocubero.github.io/capas_TFG/localidades2.geojson",
         quiet = TRUE)

lista_aprobacion <- unique(cuadrantes$APROB)
lista_aprobacion <- sort(lista_aprobacion)
lista_aprobacion <- c("Todos", lista_aprobacion)


lista_canton <- unique(cuadrantes$CANTON)
lista_canton <- sort(lista_canton)
lista_canton <- c("Todos", lista_canton)


lista_distrito <- unique(cuadrantes$DISTRITO)
lista_distrito <- sort(lista_distrito)
lista_distrito <- c("Todos", lista_distrito)

# sf::sf_use_s2(FALSE)


```

Column {.sidebar}
-----------------------------------------------------------------------
```{r}

h2(" Cuadrantes Aprobados")
selectInput(
  inputId = "aprob",
  label = "Aprobado",
  choices = lista_aprobacion,
  selected = "Todos"
)

h2("Cantones")
selectInput(
  inputId = "canton",
  label = "Cantón",
choices = lista_canton,
  selected = "Todos"
)

h2("Distrito")
selectInput(
  inputId = "distrito",
label = "Distritos",
  choices = lista_distrito,
  selected = "Todos"
)



 filtrarRegistros <-  reactive({
  cuadrantes_f <-
   cuadrantes  %>%
  dplyr::select(aprob)
  
  cuadrantes_f <-
    cuadrantes_f  %>%


   if (input$aprob != "Todos") {
    cuadrantes_f <-
      cuadrantes_f %>%
      filter(aprob == input$aprob)
  }
  
 
  if (input$canton != "Todos") {
   cuadrantes_f <-
      cuadrantes_f %>%
      filter(canton == input$canton)
  }
  
  
  if (input$distrito != "Todos") {
    cuadrantes_f <-
      cuadrantes_f %>%
      filter(distrito == input$distrito)
  }
  
  return(cuadrantes_f)
 })


```

Column {data-width=650}
-----------------------------------------------------------------------

### Visor

```{r}


colores <- c( "#4DAF4A" , "#B2FFFC","#FFFF33" )
c_zona <- levels(as.factor(cuadrantes$NOMB_ZONA))
paleta <- colorFactor(palette = colores, domain = c_zona)

icon_1 <- makeAwesomeIcon(
  icon= "graduation-cap",
  iconColor = "#87CEEB",
  markerColor = "blue",
  library = "fa"
)

icon_2 <- makeAwesomeIcon(
  icon= "location-arrow",
  iconColor = "#00FF7F",
  markerColor = "#713d35",
  library = "fa"
)


renderLeaflet({
 registros <-
  filtrarRegistros()
 
 

leaflet() %>%
    addTiles(group = "OSM") %>%
    addProviderTiles(providers$Esri.NatGeoWorldMap , group = "NatGeo"
                     ) %>%
    addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB-Black"
                     ) %>%
    addProviderTiles("Esri.WorldImagery", group= "ESRI") %>%
  
  
  addPolygons(
      data = registros,
      color = ~paleta(NOMB_ZONA),
      fillOpacity = 1,
      weight = 1,
      opacity = 1,
      stroke = TRUE,
      group = "Cuadrantes",
      popup= paste0( "<strong> Cuadrante: <strong/>",
      registros$POBLADO)
    ) %>%
    
    addLegend(
      pal = paleta,
      values = registros$NOMB_ZONA,
      opacity = 1,
      title = "Zona"
    ) %>%
  
  
  addAwesomeMarkers(
      data = mep_f,
      icon= icon_1,
      popup = paste0(
      mep_f$Nivel,
       ":<br>",
      mep_f$Nombre   
       ),
      group= "Centros Educativos"
     ) %>%
    
     addAwesomeMarkers(
      data = localidades_f,
      icon= icon_2,
      popup = paste0(
      localidades_f$nombre   
       ),
      group= "Localidades"
     ) %>%  
  
  
  
  
 addLayersControl(
      "bottomleft",
      baseGroups = c("OSM", "NatGeo", "CartoDB-Black", "ESRI"),
      overlayGroups = c(
        "Cantones" , "Cuadrantes" , "Centros Educativos" , "Localidades"
      ),
      options = layersControlOptions(collapsed = TRUE)
    ) %>%
    addScaleBar("bottomright") %>%
    addMiniMap() %>%
    addResetMapButton() %>%
    addFullscreenControl() %>%
    addControlGPS() %>%
    addSearchOSM() %>%
    addMouseCoordinates()

})
```

Column {data-width=350}
-----------------------------------------------------------------------


### Tabla

```{r}

```

### Información

```{r}

```

![](https://marcelocubero.github.io/capas_TFG/5.png){width='450px'} 
![](https://marcelocubero.github.io/capas_TFG/INVU.jpg){width='450px'}